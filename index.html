<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ランダム文字列生成</title>
	<script type="text/javascript" src="./RandomStrings.js"></script>
	<style>
		body, div, p {
			margin:0;
			padding:0;
			border:0;
		}
		h1,h2,h3,h4,h5,h6 {
			margin-top:0.8em;
			margin-bottom:0.1em;
		}
		h1{
			font-size: 1.2em;
		}
		h2{
			font-size: 1.1em;
			background-color: #ddddff;
			padding: 0.3em 0;
			margin-bottom: 0.3em;
		}
		.container {
			padding: 0.3em;
			word-break: break-all;
			line-height: 1.5em;
		}
		#gen_rand_str table {
			border-collapse: collapse;
			margin-bottom: 0.5em;
		}
		#gen_rand_str table tr>*:first-child {
			width: 4.5em;
		}
		#gen_rand_str table td {
			border: 1px solid #dddddd;
			padding: 0.2em;
		}
		#gen_rand_str input[type="text"],
		#gen_rand_str input[type="number"]{
			font-size:1.1em;
		}
		.strtypes input[type='text'].invalid {
			background-color: #ffcccc;
		}
		.symbols {
			display: inline-block;
			border: 1px solid #cccccc;
			background-color: #dddddd;
			border-radius: 0.3em;
			margin-bottom: 0.3em;
			width:2.6em;
		}
		.symbols input[type="checkbox"]{
			padding: 0;
			margin: 0 0 0 0.3em;
		}
		.symbols.checked{
			background-color:#88eeaa;
		}
		.gen_result{
			border: 1px solid #cccccc;
			background-color: #eeeeee;
			padding: 0.2em;
			margin: 0.3em 0;
			cursor: pointer;
		}
		.gen_result.copied{
			background-color:#88eeaa;
		}
		#run_button{
			padding:0.2em 0.6em;
			font-size: 1em;
		}
	</style>
	<script>
		var onloaded = function(){
			var symbols = document.querySelectorAll(".symbols input[type='checkbox']");
			symbols.forEach(function(elem, key){
				elem.onclick = function(){
					toggleSymbolsColor(elem);
				};
				toggleSymbolsColor(elem);
			})
			var strtypes = document.querySelectorAll(".strtypes input[type='checkbox']");
			strtypes.forEach(function(elem, key){
				elem.onclick = function(){
					toggleTypeTextDisabled(elem);
				};
				toggleTypeTextDisabled(elem);
			})
			var strtypevalues = document.querySelectorAll(".strtypes input[type='text']");
			strtypevalues.forEach(function(elem, key){
				elem.onchange = function(){
					validTypeText(elem);
				}
				validTypeText(elem);
			})
			run();
		};
		var validate = function(){
			var valid = true;
			var strtypevalues = document.querySelectorAll(".strtypes input[type='text']");
			strtypevalues.forEach(function(elem, key){
				if(!validTypeText(elem)){
					valid = false;
				}
			})
			return valid;
		}
		var validTypeText = function(elem){
			var regvalue = document.querySelector("#"+ String(elem.id).replace(/_values/, "")).value;
			var regex = new RegExp("^[" + regvalue + "]+$");
			elem.classList.remove("invalid");
			if(!elem.value.match(regex)){
				var msg = [];
				msg.push("指定可能な文字列のみ入力してください");
				msg.push("入力された文字："+elem.value);
				msg.push("入力可能な文字："+regvalue.replace(/\-/, "～"));
				alert(msg.join("\r\n"));
				elem.classList.add("invalid");
				elem.focus();
				return false;
			}
			return true;
		};
		var toggleTypeTextDisabled = function(elem){
			document.querySelector("#"+elem.id+"_values").disabled = !elem.checked;
			var checkedstrtypes = document.querySelectorAll(".strtypes input[type='checkbox']:checked");
			if(checkedstrtypes.length){
				document.querySelector("#presuffix").disabled = false;
			} else {
				document.querySelector("#presuffix").disabled = true;
				document.querySelector("#presuffix").checked = false;
			}
		};
		var toggleSymbolsColor = function(elem){
			var checkedsymbols = document.querySelectorAll(".symbols input[type='checkbox']:checked");
			document.querySelector("#strtype_symbol").checked = checkedsymbols.length ? true : false;
			if(elem.checked){
				elem.parentNode.classList.add('checked');
			} else {
				elem.parentNode.classList.remove('checked');
			}
		};
		var run = function(){
			var requiredptn = [];
			var selectedstrtypes = [];
			var selectedptntypes = [];

			if(!validate()){
				return false;
			}
			var strtypes = document.querySelectorAll(".strtypes input[type='checkbox']:checked");
			strtypes.forEach(function(elem, key){
				selectedstrtypes.push(document.querySelector("#"+elem.id+"_values").value);
				selectedptntypes.push(elem.value);
				requiredptn.push("(?=.*[" + elem.value + "])");
			})

			var selectedstrsymbols = [];
			var selectedptnsymbols = [];
			var symbols = document.querySelectorAll(".symbols input[type='checkbox']:checked");
			symbols.forEach(function(elem, key){
				selectedstrsymbols.push(elem.value.replace(/(\\)([^\\])/, function(matched, str1, str2){ return str2; }));
				selectedptnsymbols.push(elem.value);
			})
			if(selectedptnsymbols.length) requiredptn.push("(?=.*[" + selectedptnsymbols.join("") + "])");

			var $presuffix = document.querySelector("#presuffix");
			var presuffixptn = !$presuffix.disabled && $presuffix.checked ? "[" + selectedptntypes.join("") + "]" : "";

			var optptn = "^" + requiredptn.join("") + presuffixptn + "[" + selectedptntypes.join("") + selectedptnsymbols.join("") + "]+" + presuffixptn + "$";
			var optstr = selectedstrtypes.join("") + selectedstrsymbols.join("");
			var optnum = document.querySelector("#gen_num").value || 1;
			var optlen = document.querySelector("#gen_len").value || 24;
			var optmax = document.querySelector("#gen_max").value || 999;

			// call construct and overwrite options
			var rs=new RandomStrings({
				// ptn:"^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[\-\_])(?=.*[\+])[0-9a-zA-Z][0-9a-zA-Z\-\_\+]+[0-9a-zA-Z]$",
				// str:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890-_",
				ptn:optptn,
				str:optstr,
				num:optnum,
				len:optlen,
				max:optmax,
				show:false
			});
			// execute
			var res = rs.exec("#runlog");
			var $result = document.querySelector("#result");
			$result.innerHTML = "";
			res.forEach(function(val, i){
				var $rs = document.createElement("p");
				$rs.innerHTML = val;
				$rs.classList.add("gen_result");
				$rs.setAttribute("readonly", "readonly");
				$result.appendChild($rs);
				$rs.onclick = function(){
					var results = document.querySelectorAll(".gen_result");
					results.forEach(function(elem, key){
						elem.classList.remove("copied");
					})
					toclipboard(val);
					$rs.classList.add("copied");
				};
			});
		}
		var copyAll = function(){
			var copystrings = [];
			var results = document.querySelectorAll(".gen_result");
			results.forEach(function(elem, key){
				elem.classList.remove("copied");
				copystrings.push(elem.innerText);
				elem.classList.add("copied");
			})
			toclipboard(copystrings.join("\r\n"));
		}
		var toclipboard = function(text){
			let choise;
			let res;

			if(navigator.userAgent.match(/ipad|iphone/i)){
				choise = "navigator.userAgent.match(/ipad|iphone/i)";
				let range = document.createRange();
				range.selectNodeContents(ta);
				let sel = window.getSelection();
				sel.removeAllRanges();
				sel.addRange(range);
				res = document.execCommand("copy");
			}
			else if(window.clipboardData){
				choise = "window.clipboardData";
				res = window.clipboardData.setData("Text" , text);
			}
			else if(navigator.clipboard){
				choise = "navigator.clipboard";
				res = navigator.clipboard.writeText(text);
			}
			else {
				choise = "ta.select()";
				let ta = document.createElement("textarea");
				ta.value = text;
				ta.setAttribute("readonly", "readonly");
				ta.setAttribute("contenteditable", true);
				ta.style.top = "0";
				ta.style.left = "0";
				ta.style.position = "fixed";
				try {
					document.body.appendChild(ta);
					ta.focus();
					ta.select();
					res = document.execCommand("copy");
				} finally {
					document.body.removeChild(ta);
	//				ta.parentElement.removeChild(ta);
				}
			}
			if(!!!res){
				window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
			}
	//		console.log("toclipboard:%s, text:%s, case:%s", res, text, choise);
			return res;
		}
	</script>
</head>
<body onload="onloaded()">
	<div class="container">
		<h1>
			ランダム文字列生成<a href="https://github.com/tokiori/RandomStrings">(github repository)</a>
		</h1>
		<form id="gen_rand_str">
			<h2>生成条件</h2>
			<table>
				<tr>
					<td>生成長</td>
					<td><input class="genoptions" type="number" id="gen_len" value="24"></td>
				</tr>
				<tr>
					<td>生成個数</td>
					<td><input class="genoptions" type="number" id="gen_num" value="1"></td>
				</tr>
				<tr>
					<td>半角英数</td>
					<td>
						<div class="strtypes">
							<input type="checkbox" value="A-Z" id="strtype_upper" name="strtype_upper" checked>
							<label for="strtype_upper">英大</label>
							<input type="text" id="strtype_upper_values" value="ABCDEFGHIJKLMNOPQRSTUVWXYZ">
						</div>
						<div class="strtypes">
							<input type="checkbox" value="a-z" id="strtype_lower" name="strtype_lower" checked>
							<label for="strtype_lower">英小</label>
							<input type="text" id="strtype_lower_values" value="abcdefghijklmnopqrstuvwxyz">
						</div>
						<div class="strtypes">
							<input type="checkbox" value="0-9" id="strtype_number" name="strtype_number" checked>
							<label for="strtype_number">数字</label>
							<input type="text" id="strtype_number_values" value="1234567890">
						</div>
					</td>
				</tr>
				<tr>
					<td>記号</td>
					<td>
						<div class="">
							<input type="checkbox" value="" id="strtype_symbol" name="strtype_symbol" disabled>
							<label for="strtype_symbol">下記いずれかを含む</label>
						</div>
						<div>
							<label class="symbols" for="symbol_underscore">
								<input type="checkbox" value="\_" id="symbol_underscore" name="symbol_underscore" checked>
								_
							</label>
							<label class="symbols" for="symbol_hyphen">
								<input type="checkbox" value="\-" id="symbol_hyphen" name="symbol_hyphen" checked>
								-
							</label>
							<label class="symbols" for="symbol_plus">
								<input type="checkbox" value="\+" id="symbol_plus" name="symbol_plus">
								+
							</label>
							<label class="symbols" for="symbol_asterisk">
								<input type="checkbox" value="\*" id="symbol_asterisk" name="symbol_asterisk">
								*
							</label>
							<label class="symbols" for="symbol_slash">
								<input type="checkbox" value="\/" id="symbol_slash" name="symbol_slash">
								/
							</label>
							<label class="symbols" for="symbol_percent">
								<input type="checkbox" value="\%" id="symbol_percent" name="symbol_percent">
								%
							</label>
							<label class="symbols" for="symbol_question">
								<input type="checkbox" value="\?" id="symbol_question" name="symbol_question">
								?
							</label>
							<label class="symbols" for="symbol_exclamation">
								<input type="checkbox" value="\!" id="symbol_exclamation" name="symbol_exclamation">
								!
							</label>
							<label class="symbols" for="symbol_sharp">
								<input type="checkbox" value="\#" id="symbol_sharp" name="symbol_sharp">
								#
							</label>
							<label class="symbols" for="symbol_atmark">
								<input type="checkbox" value="\@" id="symbol_atmark" name="symbol_atmark">
								@
							</label>
							<label class="symbols" for="symbol_colon">
								<input type="checkbox" value="\:" id="symbol_colon" name="symbol_colon">
								:
							</label>
							<label class="symbols" for="symbol_semicolon">
								<input type="checkbox" value="\;" id="symbol_semicolon" name="symbol_semicolon">
								;
							</label>
						</div>
					</td>
				</tr>
				<tr>
					<td>生成条件</td>
					<td>
						<div class="presuffix">
							<input type="checkbox" value="0-9" id="presuffix" name="presuffix" checked>
							<label for="presuffix">先頭末尾は半角英数</label>
						</div>
					</td>
				</tr>
				<tr>
					<td>試行回数</td>
					<td><input class="genoptions" type="number" id="gen_max" value="999"></td>
				</tr>
			</table>
			<input id="run_button" type="button" value="生成実行" onclick="run()" style="font-weight: bold;">
		</form>
		<div>
			<h2>生成結果</h2>
			<p>
				タップでクリップボードへコピー
				<input id="copy_button" type="button" value="一括コピー" onclick="copyAll()" style="font-weight: bold;">
			</p>
			<p id="result"></p>
		</div>
		<div>
			<h2>実行ログ</h2>
			<p id="runlog"></p>
		</div>
	</div>
</body>
</html>
